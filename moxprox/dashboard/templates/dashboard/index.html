<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      body {
          margin: 0;
          height: 100vh;
          overflow: hidden;
      }
      #left-container, #right-container {
          height: calc(100vh - 80px); /* Adjust height to account for header */
          overflow: auto;
      }
      #divider {
          width: 5px;
          cursor: ew-resize;
          background-color: #ddd;
          height: 100%;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
          <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"></use></svg>
          <span class="fs-4">Simple header</span>
        </a>
        <ul class="nav nav-pills">
          <li class="nav-item"><a href="#" class="nav-link active" aria-current="page">Home</a></li>
          <li class="nav-item"><a href="#" class="nav-link">Features</a></li>
          <li class="nav-item"><a href="#" class="nav-link">Pricing</a></li>
          <li class="nav-item"><a href="#" class="nav-link"websockify>FAQs</a></li>
          <li class="nav-item"><a href="#" class="nav-link">About</a></li>
        </ul>
    </header>

    <div class="d-flex" style="height: calc(100vh - 80px);">
        <!-- Left Container -->
        <div id="left-container" style="flex: 0 0 30%; background-color: #f8f9fa; padding: 1rem;">
            <h5>DataCenter</h5>
            <ul class="list-unstyled">
                {% for node in nodes %}
                <li>

                    <a class="dropdown-item d-flex gap-2 align-items-center" data-bs-toggle="collapse" href="#node-127-0-0-1" role="button" aria-expanded="false" aria-controls="node-127-0-0-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16">
                            <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                        </svg>
                        {{ node.name }}
                    </a>
                    <ul class="collapse list-unstyled ps-5" id="node-127-0-0-1">
                        {% for domain in domains %}
                        {% if domain.node_id == node.id %}
                        <li>
                            <a class="dropdown-item" href="#" onclick="loadVM('{{ domain.name }}', 
                                                                              '{{ domain.uuid }}', 
                                                                              '{{ domain.status }}', 
                                                                              '{{ domain.current_ram }}', 
                                                                              '{{ domain.max_ram }}', 
                                                                              '{{ domain.vcpus }}',
                                                                              '{{ domain.vnc_port }}',
                                                                              '{{ node.ip }}',
                                                                              '{{ domain.proxy_port}}')">
                            {{ domain.name }} {{ domain.uuid }}
                            </a>
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </li>
                {% endfor %}
            </ul>
        </div>
    
        <!-- Divider (resizable) -->
        <div id="divider" style="width: 5px; cursor: ew-resize; background-color: #ddd;"></div>
    
        <!-- Right Container -->
        <div id="right-container" style="flex: 1; background-color: #fff; padding: 1rem;">
            <h5>Affichage de la VM</h5>
            <div id="vm-content" class="border p-3" style="height: 100%; overflow-y: auto;">
                <p>Sélectionnez une VM pour afficher son contenu.</p>
            </div>
        </div>
    </div>
    <script>
        // Load VM content
        function loadVM(vmName) {
            const vmContent = document.getElementById('vm-content');
            vmContent.innerHTML = `<h6>${vmName} Details</h6><p>Contenu de ${vmName} chargé ici.</p>`;
        }
    </script>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // Adjust the split layout
        const divider = document.getElementById("divider");
        const leftContainer = document.getElementById("left-container");
        const rightContainer = document.getElementById("right-container");

        let isDragging = false;

        divider.addEventListener("mousedown", (e) => {
            isDragging = true;
            document.body.style.cursor = "ew-resize";
        });

        document.addEventListener("mousemove", (e) => {
            if (!isDragging) return;

            const totalWidth = divider.parentElement.offsetWidth;
            const leftWidth = e.clientX;
            const rightWidth = totalWidth - leftWidth - divider.offsetWidth;

            if (leftWidth > 100 && rightWidth > 100) {
                leftContainer.style.flex = `0 0 ${leftWidth}px`;
                rightContainer.style.flex = `1 1 auto`;
            }
        });

        document.addEventListener("mouseup", () => {
            isDragging = false;
            document.body.style.cursor = "default";
        });

        function loadVM(vmName, vmUUID, status, ramUsed, ramMax, vcpus, vncport, node_ip, domain_proxy_port) {
            const vmContent = document.getElementById('vm-content');
            
            // Générer le contenu dynamique pour la VM
            vmContent.innerHTML = `
                <h6 id="vm-name"   >Détails de ${vmName}</h6>
                <div  ><strong>UUID:</strong><div id="vm-uuid">${vmUUID}</div></div></br>
                <p  id="vm-status" ><strong>Status:</strong> ${status}</p>
                <p  id="vm-ramused"><strong>RAM Utilisée:</strong> ${ramUsed/1024} MB / <strong>RAM Maximale:</strong> ${ramMax/1024} MB</p>
                <p  id="vm-vcpus"  ><strong>Nombre de vCPUs:</strong> ${vcpus}</p>
                <p  id="vm-vncport"><strong>VNC Port:</strong> ${vncport}</p>
                
                <div>
                    <button onclick="manageVM('${vmUUID}', 'create_domain')" class="btn btn-success">Démarrer</button>
                    <button onclick="manageVM('${vmUUID}', 'destroy_domain')" class="btn btn-danger">Arrêter</button>
                    <button onclick="manageVM('${vmUUID}', 'restart_domain_unblock')" class="btn btn-warning">Redémarrer</button>
                </div>
                
                <div id="console" class="mt-4">
                    <h6>Console</h6>
                    <iframe id="vnc-console" src="http://${node_ip}:${domain_proxy_port}/vnc.html" style="width: 100%; height: 500px; border: none;"></iframe>
                </div>
            `;
        }
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function manageVM(uuid_to_act, action) {
            if (action != 'create_domain' && action != 'restart_domain_unblock' && action != 'destroy_domain')
            {
                alert(`Action invalide:"${action}"`);
            }

            let url = `/dashboard/manage_domain/`;
            const token = getCookie('csrftoken');
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': token
                },
                body: JSON.stringify({ uuid: uuid_to_act, action: action  }),
            })
            .catch(error => {
                console.error(`Erreur lors de l'action "${action}":`, error);
            });
        }
    </script>
    <script>
        function fetchStatus() {
        fetch('/dashboard/refresh/') 
            .then(response => response.json())
            .then(data => {
                updateUI(data);
            })
            .catch(error => console.error('Erreur lors de la récupération des données:', error));
    }

    function updateUI(data) {
        console.log(data)

        data.nodes.forEach(node => {
            node.domains.forEach(domain => {
                const uuid    = document.getElementById('vm-uuid');  
                if ( uuid.innerText == domain.uuid )
                {
                    const name    = document.getElementById('vm-name');   
                    const status  = document.getElementById('vm-status'); 
                    const ramused = document.getElementById('vm-ramused');
                    const vcpus   = document.getElementById('vm-vcpus');  
                    const vncport = document.getElementById('vm-vncport');
                    const iframevnc = document.getElementById('vnc-console');
                    
                    name   .innerHTML = `<h6 id="vm-name"   >Détails de ${domain.name}</h6>`,
                    status .innerHTML = `<p  id="vm-status" ><strong>Status:</strong> ${domain.status}</p>`,
                    ramused.innerHTML = `<p  id="vm-ramused"><strong>RAM Utilisée:</strong> ${domain.current_ram/1024} MB / <strong>RAM Maximale:</strong> ${domain.max_ram/1024} MB</p>`,
                    vcpus  .innerHTML = `<p  id="vm-vcpus"  ><strong>Nombre de vCPUs:</strong> ${domain.vcpus}</p>`,
                    vncport.innerHTML = `<p  id="vm-vncport"><strong>VNC Port:</strong> ${domain.vnc_port}</p>`
                
                    if (!(iframevnc.innerHTML.includes(`:${domain.proxy_port}`)))
                    {
                        iframevnc.innerHTML = `<iframe id="vnc-console" src="http://${node.ip}:${domain.proxy_port}/vnc.html" style="width: 100%; height: 500px; border: none;"></iframe>`
                    }
                } 
            });
        });
    }

    setInterval(fetchStatus, 10000);
    </script>
  </body>
</html>
